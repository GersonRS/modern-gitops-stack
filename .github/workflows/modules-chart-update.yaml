---
# GitHub Actions workflow para atualizar dependÃªncias dos Helm charts da Modern Gitops Stack.
#
# Este workflow automatiza a atualizaÃ§Ã£o das dependÃªncias dos charts utilizados na infraestrutura
# Modern Gitops Stack, criando PRs para facilitar a revisÃ£o e deploy das atualizaÃ§Ãµes.

name: "modules-chart-update"

on:
  workflow_call:
    secrets:
      PROJECT_APP_PRIVATE_KEY:
        description: "GitHub token para o projeto Modern Gitops Stack"
        required: true
    inputs:
      update-strategy:
        description: "EstratÃ©gia de atualizaÃ§Ã£o. Valores vÃ¡lidos: 'major', 'minor' ou 'patch'"
        type: string
        required: true
      excluded-dependencies:
        description: "Lista separada por vÃ­rgulas de dependÃªncias a excluir (ex: 'dependency1,dependency2')"
        type: string
        required: false
        default: ""
      dry-run:
        description: "Se deve executar em modo dry-run ou nÃ£o"
        type: boolean
        required: false
        default: false

jobs:
  list-charts:
    name: "Listar charts Modern Gitops Stack"
    runs-on: ubuntu-latest

    outputs:
      charts: ${{ steps.find-charts.outputs.charts }}

    steps:
      - name: "Fazer checkout do repositÃ³rio Modern Gitops Stack"
        uses: actions/checkout@v6

      - name: "Listar charts na pasta ./charts"
        id: find-charts
        run: cd charts && echo "charts=$(find . -maxdepth 2 -name 'Chart.yaml' -exec dirname {} \; | sed 's|^\./||' | sort -u | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT

  chart-update:
    name: "Atualizar chart: ${{ matrix.chart-name }}"
    runs-on: ubuntu-latest

    needs: list-charts

    strategy:
      matrix:
        chart-name: ${{ fromJson(needs.list-charts.outputs.charts) }}

    # Define global settings for both PR steps.
    env:
      author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

    steps:
      - name: "Fazer checkout do repositÃ³rio Modern Gitops Stack"
        uses: actions/checkout@v6

      - name: "Atualizar dependÃªncias do Helm chart"
        id: deps-update
        uses: camptocamp/helm-dependency-update-action@v0.5.0
        with:
          chart-path: "charts/${{ matrix.chart-name }}"
          readme-path: "README.adoc"
          excluded-dependencies: ${{ inputs.excluded-dependencies }}
          update-strategy: "${{ inputs.update-strategy }}"
          dry-run: "${{ inputs.dry-run }}"

      - name: "Criar Pull Request para atualizaÃ§Ã£o minor/patch"
        if: ${{ !inputs.dry-run && steps.deps-update.outputs.update-type != 'none' && steps.deps-update.outputs.update-type != 'major' }}
        id: minor-pr
        uses: peter-evans/create-pull-request@v8
        env:
          pr-title: "feat(chart): atualizaÃ§Ã£o ${{ steps.deps-update.outputs.update-type }} de dependÃªncias no chart ${{ matrix.chart-name }}"
          branch: "chart-autoupdate-${{ steps.deps-update.outputs.update-type }}-${{ matrix.chart-name }}"
          labels: "chart-autoupdate-${{ steps.deps-update.outputs.update-type }}"
        with:
          token: ${{ secrets.PROJECT_APP_PRIVATE_KEY }}
          base: ${{ github.head_ref }}
          commit-message: ${{ env.pr-title }}
          author: ${{ env.author }}
          committer: ${{ env.author }}
          branch: "chart-autoupdate-${{ steps.deps-update.outputs.update-type }}-${{ matrix.chart-name }}"
          title: ${{ env.pr-title }}
          labels: "chart-autoupdate-${{ steps.deps-update.outputs.update-type }}"
          signoff: true
          assignees: GersonRS
          reviewers: GersonRS
          delete-branch: true
          body: |
            ğŸ¤– Atualizei o chart automaticamente do Modern Gitops Stack *beep* *boop*
            ---

            ## ğŸ“‹ DescriÃ§Ã£o

            ### O que mudou?
            Este PR atualiza as dependÃªncias do Helm chart **${{ matrix.chart-name }}** do Modern Gitops Stack.

            ### Por que foi necessÃ¡rio?
            AtualizaÃ§Ã£o automÃ¡tica para manter os charts seguros e atualizados.

            ## ğŸ”§ Tipo de MudanÃ§a
            - [x] ğŸ”§ ConfiguraÃ§Ã£o/Charts

            ## ğŸ“Š Detalhes da AtualizaÃ§Ã£o
            - **Chart**: ${{ matrix.chart-name }}
            - **Tipo de atualizaÃ§Ã£o**: ${{ steps.deps-update.outputs.update-type }}
            - **EstratÃ©gia**: AtualizaÃ§Ã£o automÃ¡tica segura

            ## âœ… Checklist
            - [x] DependÃªncias atualizadas automaticamente
            - [x] Seguindo conventional commits
            - [x] Labels apropriadas aplicadas

      - name: "Criar Pull Request para atualizaÃ§Ã£o major"
        if: ${{ !inputs.dry-run && steps.deps-update.outputs.update-type != 'none' && steps.deps-update.outputs.update-type == 'major' }}
        id: major-pr
        uses: peter-evans/create-pull-request@v8
        env:
          pr-title: "feat(chart)!: atualizaÃ§Ã£o major de dependÃªncias no chart ${{ matrix.chart-name }}"
        with:
          token: ${{ secrets.PROJECT_APP_PRIVATE_KEY }}
          base: ${{ github.head_ref }}
          commit-message: ${{ env.pr-title }}
          author: ${{ env.author }}
          committer: ${{ env.author }}
          branch: "chart-autoupdate-major-${{ matrix.chart-name }}"
          title: ${{ env.pr-title }}
          labels: "chart-autoupdate-major"
          signoff: true
          assignees: GersonRS
          reviewers: GersonRS
          delete-branch: true
          body: |
            ğŸ¤– Atualizei o chart automaticamente do Modern Gitops Stack *beep* *boop*
            ---

            ## ğŸ“‹ DescriÃ§Ã£o

            ### O que mudou?
            Este PR atualiza as dependÃªncias do Helm chart **${{ matrix.chart-name }}** do Modern Gitops Stack.

            ### Por que foi necessÃ¡rio?
            AtualizaÃ§Ã£o automÃ¡tica para manter os charts seguros e atualizados.

            ## ğŸ”§ Tipo de MudanÃ§a
            - [x] ğŸ’¥ Breaking change
            - [x] ğŸ”§ ConfiguraÃ§Ã£o/Charts

            ## âš ï¸ AtenÃ§Ã£o - AtualizaÃ§Ã£o Major!

            Esta foi uma **atualizaÃ§Ã£o major**! Por favor:
            1. ğŸ“– Verifique o changelog das dependÃªncias atualizadas
            2. ğŸ” Revise cuidadosamente as breaking changes
            3. ğŸ§ª Teste em ambiente de desenvolvimento antes do merge
            4. ğŸ“š Atualize a documentaÃ§Ã£o se necessÃ¡rio

            ## ğŸ“Š Detalhes da AtualizaÃ§Ã£o
            - **Chart**: ${{ matrix.chart-name }}
            - **Tipo**: Major update (pode conter breaking changes)
            - **Componentes afetados**: Modern Gitops Stack

            ## âœ… Checklist de RevisÃ£o
            - [ ] Verificar changelog das dependÃªncias
            - [ ] Revisar breaking changes
            - [ ] Testar em ambiente de desenvolvimento
            - [ ] Validar impacto no Modern Gitops Stack
            - [ ] Atualizar documentaÃ§Ã£o se necessÃ¡rio