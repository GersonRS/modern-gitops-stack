---
# Workflow do GitHub Actions para gerar automaticamente documentação dos arquivos .tf do módulo.
# A documentação gerada será injetada entre comentários AsciiDoc no README.adoc.
#
# IMPORTANTE: Este workflow é chamado por outros workflows nos repositórios do Modern Gitops Stack e está
# centralizado aqui para facilitar a manutenção entre módulos. Por isso, certifique-se de não introduzir
# mudanças que quebrem a compatibilidade ao modificar este workflow.

name: "modules-terraform-docs"

on:
  workflow_call:
    inputs:
      variants:
        description: "Lista das pastas de variantes como uma lista separada por vírgulas dentro de uma string (ex: 'eks,aks')."
        type: string
        required: false
        default: ""

env:
  ARGS: "--hide-empty=true --sort=false" # Não mostrar seções vazias e não ordenar itens
  DOCS_TPL: "// BEGIN_TF_DOCS\n{{ .Content }}\n// END_TF_DOCS" # Definir template compatível com AsciiDoc
  TABLES_TPL: "// BEGIN_TF_TABLES\n{{ .Content }}\n// END_TF_TABLES" # Definir template compatível com AsciiDoc

jobs:
  terraform-docs:
    runs-on: ubuntu-latest

    steps:
      - name: "Fazer checkout do repositório"
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: "Gerar documentação Terraform"
        uses: terraform-docs/gh-actions@v1.4.1
        with:
          working-dir: .
          indention: 3
          output-format: asciidoc document
          output-file: README.adoc
          output-method: inject
          template: ${{ env.DOCS_TPL }}
          args: ${{ env.ARGS }}
          git-push: false

      - name: "Gerar tabelas Terraform"
        uses: terraform-docs/gh-actions@v1.4.1
        with:
          working-dir: .
          indention: 1 # Como os cabeçalhos não são lidos dentro do bloco recolhível, podemos indentar como 1
          output-format: asciidoc table
          output-file: README.adoc
          output-method: inject
          template: ${{ env.TABLES_TPL }}
          args: ${{ env.ARGS }}
          git-push: false

      - name: "Gerar documentação Terraform para as variantes"
        if: ${{ inputs.variants != '' }}
        uses: terraform-docs/gh-actions@v1.4.1
        with:
          working-dir: ${{ inputs.variants }}
          indention: 3
          output-format: asciidoc document
          output-file: README.adoc
          output-method: inject
          template: ${{ env.DOCS_TPL }}
          args: ${{ env.ARGS }}
          git-push: false

      - name: "Gerar tabelas Terraform para as variantes"
        if: ${{ inputs.variants != '' }}
        uses: terraform-docs/gh-actions@v1.4.1
        with:
          working-dir: ${{ inputs.variants }}
          indention: 1 # Como os cabeçalhos não são lidos dentro do bloco recolhível, podemos indentar como 1
          output-format: asciidoc table
          output-file: README.adoc
          output-method: inject
          template: ${{ env.TABLES_TPL }}
          args: ${{ env.ARGS }}
          git-push: false

      # Este passo vem após longas horas de depuração de erros de permissão no workflow ao tentar fazer commit
      # após executar as ações do terraform-docs. Veja https://github.com/terraform-docs/gh-actions/issues/90
      - name: "Corrigir propriedade dos arquivos em preparação para o próximo passo"
        run: sudo chown runner:docker -Rv .git

      # Este passo evita um commit para cada passo anterior e em vez disso faz commit de tudo em um único commit
      - name: "Fazer commit das mudanças feitas nos passos anteriores"
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "docs(terraform-docs): gerar docs e escrever no README.adoc"